From 1b58259ac71b5cf01187fc3f7a92dbc345e7f11b Mon Sep 17 00:00:00 2001
From: Mirza Krak <mirza.krak@northern.tech>
Date: Wed, 22 Aug 2018 15:08:58 +0200
Subject: [PATCH 10/10] Add canary value to U-Boot env to catch
 bootloader/user-space mismatch

Forward port of:

https://github.com/mendersoftware/meta-mender/commit/b36907b823b4f20df013ca5644ccde8c8ea12e7c#diff-761dfcb0a89ca945734e2e004048c8ee

Signed-off-by: Mirza Krak <mirza.krak@northern.tech>
---
 include/env_mender.h | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/include/env_mender.h b/include/env_mender.h
index 3fb65be8b1..d8690a350d 100644
--- a/include/env_mender.h
+++ b/include/env_mender.h
@@ -62,7 +62,13 @@
                                                                         \
     "mender_post_setup_commands=" MENDER_UBOOT_POST_SETUP_COMMANDS "\0" \
                                                                         \
+    "mender_check_saveenv_canary=1\0"                                   \
+                                                                        \
     "mender_setup="                                                     \
+    "if test \"${mender_saveenv_canary}\" != \"1\"; then "              \
+    "setenv mender_saveenv_canary 1; "                                  \
+    "saveenv; "                                                         \
+    "fi; "                                                              \
     "if test \"${mender_pre_setup_commands}\" != \"\"; "                \
     "then "                                                             \
     "run mender_pre_setup_commands; "                                   \
-- 
2.18.0

